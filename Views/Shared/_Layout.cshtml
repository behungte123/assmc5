@using Microsoft.AspNetCore.Identity
@using Lab4.Models   @* đổi cho đúng ApplicationUser của bạn *@
@using lab4.Models
@inject SignInManager<ApplicationUser> SignInManager
@inject UserManager<ApplicationUser> UserManager


@{
    var title = ViewData["Title"] as string ?? "Lab4";
}
<!doctype html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>@title</title>

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />

    <style>
        :root {
            --bgTop: #f4f0e6;
            --bgBottom: #e7efe9;
            --ink: #2c2c2c;
        }

        html, body {
            height: 100%;
        }

        body {
            margin: 0;
            font-family: system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif;
            color: var(--ink);
            background: radial-gradient(1200px 520px at 50% -140px, rgba(255,255,255,.92), rgba(255,255,255,0) 62%), linear-gradient(180deg, var(--bgTop) 0 40%, var(--bgBottom) 40% 100%);
            overflow-x: hidden;
        }

        .frame {
            position: fixed;
            inset: 18px;
            border-radius: 18px;
            pointer-events: none;
            box-shadow: inset 0 0 0 1px rgba(0,0,0,.06), 0 26px 60px rgba(0,0,0,.08);
        }

        .page {
            min-height: 100vh;
            padding: 26px 0 40px;
            position: relative;
        }

        .topbar {
            width: min(1220px, calc(100% - 64px));
            margin: 0 auto;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .avatar {
            width: 46px;
            height: 46px;
            border-radius: 50%;
            overflow: hidden;
            box-shadow: 0 10px 18px rgba(0,0,0,.12);
            border: 2px solid rgba(255,255,255,.7);
            background: #fff;
            flex: 0 0 auto;
        }

            .avatar img {
                width: 100%;
                height: 100%;
                object-fit: cover;
                display: block;
            }

        .menu {
            display: flex;
            align-items: center;
            gap: 18px;
            padding-bottom: 10px;
            border-bottom: 1px solid rgba(0,0,0,.20);
        }

            .menu a {
                text-decoration: none;
                color: rgba(0,0,0,.48);
                letter-spacing: .09em;
                font-size: 13px;
            }

            .menu .sep {
                color: rgba(0,0,0,.26);
            }

            /* optional active state */
            .menu a.active {
                color: rgba(0,0,0,.72);
                font-weight: 800;
            }

        @@media (max-width:520px) {
            .menu {
                gap: 10px;
            }

                .menu a {
                    font-size: 12px;
                }
        }
    </style>

    @RenderSection("Styles", required: false)
</head>

<body>
    <div class="frame"></div>

    <div class="page">
        <header class="topbar">
            <div class="avatar" title="Avatar">
                <img src="~/images/nen_home.png" alt="avatar" />
            </div>

            <nav class="menu" aria-label="Main navigation">
                <a class="@(Context.Request.Path.Value?.StartsWith("/Product/Index") == true || Context.Request.Path.Value == "/" ? "active" : "")" href="/Product/Index">HOME</a><span class="sep">|</span>
                <a class="@(Context.Request.Path.Value?.StartsWith("/Product/Menu") == true ? "active" : "")" href="/Product/Menu">MENU</a><span class="sep">|</span>
                <a class="@(Context.Request.Path.Value?.StartsWith("/Cart") == true ? "active" : "")" href="/Cart/Index">CART</a><span id="cartBadge" class="badge rounded-pill text-bg-dark" style="vertical-align:middle;">
                    0
                </span><span class="sep">|</span>
                

                <a class="@(Context.Request.Path.Value?.StartsWith("/Cart/OrderHistory") == true ? "active" : "")" href="/Cart/OrderHistory">ORDER HISTORY</a><span class="sep">|</span>
                <a class="@(Context.Request.Path.Value?.StartsWith("/Contact") == true ? "active" : "")" href="/Contact">CONTACT</a>

                <span class="sep">|</span>

                @if (SignInManager.IsSignedIn(User))
                {
                    <a class="@(Context.Request.Path.Value?.StartsWith("/Identity/Account/Manage") == true ? "active" : "")"
                       href="/Identity/Account/Manage" title="Manage">
                        @User.Identity?.Name
                    </a>

                    <span class="sep">|</span>

                    <form class="d-inline" asp-area="Identity" asp-page="/Account/Logout"
                          asp-route-returnUrl="@Url.Action("Index", "Product", new { area = "" })"
                          method="post">
                        @Html.AntiForgeryToken()
                        <button type="submit"
                                class="btn btn-link p-0 m-0 align-baseline"
                                style="text-decoration:none; color: rgba(0,0,0,.48); letter-spacing:.09em; font-size:13px;">
                            LOGOUT
                        </button>
                    </form>
                }
                else
                {
                    <a class="@(Context.Request.Path.Value?.StartsWith("/Identity/Account/Login") == true ? "active" : "")"
                       asp-area="Identity" asp-page="/Account/Login">
                        LOGIN
                    </a>

                    <span class="sep">|</span>

                    <a class="@(Context.Request.Path.Value?.StartsWith("/Identity/Account/Register") == true ? "active" : "")"
                       asp-area="Identity" asp-page="/Account/Register">
                        REGISTER
                    </a>
                }

            </nav>
        </header>

        @RenderBody()
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    @RenderSection("Scripts", required: false)
</body>
<script>
    async function refreshCartBadge() {
        try {
            const res = await fetch('/Cart/Count', { cache: 'no-store' });
            if (!res.ok) return;
            const data = await res.json();
            document.getElementById('cartBadge').textContent = data.totalQty ?? 0;
        } catch { }
    }

    document.addEventListener('DOMContentLoaded', refreshCartBadge);
</script>

</html>
